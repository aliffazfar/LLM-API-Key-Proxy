version: "3.8"

services:
  llm-proxy:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: llm-api-key-proxy
    restart: unless-stopped
    ports:
      - "8000:8000"
    volumes:
      # Mount .env files for configuration
      - ./.env:/app/.env:ro
      # Mount oauth_creds directory for OAuth credentials persistence
      - ./oauth_creds:/app/oauth_creds
      # Mount logs directory for persistent logging
      - ./logs:/app/logs
      # Mount usage directory for usage statistics persistence
      - ./usage:/app/usage
      # Optionally mount additional .env files (e.g., combined credential files)
      # - ./antigravity_all_combined.env:/app/antigravity_all_combined.env:ro
    environment:
      # === REQUIRED ===
      # Your proxy authentication key (create a strong secret)
      - PROXY_API_KEY=${PROXY_API_KEY}
      
      # === PROVIDER API KEYS ===
      # Add your provider API keys below. Format: PROVIDER_API_KEY_N
      # Examples:
      # - GEMINI_API_KEY_1=${GEMINI_API_KEY_1}
      # - GEMINI_API_KEY_2=${GEMINI_API_KEY_2}
      # - OPENROUTER_API_KEY_1=${OPENROUTER_API_KEY_1}
      # - OPENAI_API_KEY_1=${OPENAI_API_KEY_1}
      # - ANTHROPIC_API_KEY_1=${ANTHROPIC_API_KEY_1}
      
      # === OAUTH CREDENTIALS (Stateless Mode) ===
      # For Antigravity OAuth:
      # - ANTIGRAVITY_ACCESS_TOKEN=${ANTIGRAVITY_ACCESS_TOKEN}
      # - ANTIGRAVITY_REFRESH_TOKEN=${ANTIGRAVITY_REFRESH_TOKEN}
      # - ANTIGRAVITY_EXPIRY_DATE=${ANTIGRAVITY_EXPIRY_DATE}
      # - ANTIGRAVITY_EMAIL=${ANTIGRAVITY_EMAIL}
      
      # For Gemini CLI OAuth:
      # - GEMINI_CLI_ACCESS_TOKEN=${GEMINI_CLI_ACCESS_TOKEN}
      # - GEMINI_CLI_REFRESH_TOKEN=${GEMINI_CLI_REFRESH_TOKEN}
      # - GEMINI_CLI_EXPIRY_DATE=${GEMINI_CLI_EXPIRY_DATE}
      # - GEMINI_CLI_EMAIL=${GEMINI_CLI_EMAIL}
      
      # === OPTIONAL SETTINGS ===
      # Skip OAuth initialization check (set to true for stateless deployment)
      - SKIP_OAUTH_INIT_CHECK=${SKIP_OAUTH_INIT_CHECK:-true}
      
      # Model filtering (comma-separated)
      # - IGNORE_MODELS_GEMINI=${IGNORE_MODELS_GEMINI}
      # - WHITELIST_MODELS_GEMINI=${WHITELIST_MODELS_GEMINI}
      
      # Concurrency limits per provider
      # - MAX_CONCURRENT_REQUESTS_PER_KEY_GEMINI=${MAX_CONCURRENT_REQUESTS_PER_KEY_GEMINI:-5}
      
      # Rotation mode (balanced or sequential)
      # - ROTATION_MODE_ANTIGRAVITY=${ROTATION_MODE_ANTIGRAVITY:-sequential}

    # Resource limits for Oracle E2.1.Micro (1GB RAM)
    deploy:
      resources:
        limits:
          memory: 768M
        reservations:
          memory: 256M
      
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 120s
